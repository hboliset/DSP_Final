<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Table</title>
    <!-- CDN for Bootstrap CSS (for styling) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <div class="container mt-5">
      <h1>Data Table</h1>
      <button type="button" class="btn btn-success mb-2" id="insert">Insert</button>

      <!-- Insert Data Form (Initially Hidden) -->
      <div id="insert-form" class="mb-3" style="display: none;">
        <h3>Insert New Data</h3>
        <form id="data-form">
          <div class="mb-3">
            <label for="first_name" class="form-label">First Name</label>
            <input type="text" class="form-control" id="first_name" required />
          </div>
          <div class="mb-3">
            <label for="last_name" class="form-label">Last Name</label>
            <input type="text" class="form-control" id="last_name" required />
          </div>
          <div class="mb-3">
            <label for="gender" class="form-label">Gender(0/1)</label>
            <input type="text" class="form-control" id="gender" required />
          </div>
          <div class="mb-3">
            <label for="age" class="form-label">Age</label>
            <input type="number" class="form-control" id="age" required />
          </div>
          <div class="mb-3">
            <label for="weight" class="form-label">Weight(in kgs)</label>
            <input type="number" class="form-control" id="weight" required />
          </div>
          <div class="mb-3">
            <label for="height" class="form-label">Height(in cms)</label>
            <input type="number" class="form-control" id="height" />
          </div>
          <div class="mb-3">
            <label for="health_history" class="form-label">Health History</label>
            <textarea class="form-control" id="health_history"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Insert Data</button>
          <button type="button" class="btn btn-secondary" id="cancel-insert">Cancel</button>
        </form>
      </div>

      <!-- Data Table -->

      <table class="table table-bordered">
        <thead>
          <tr>
            <th></th>
            <th>ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Gender(0/1)</th>
            <th>Age</th>
            <th>Weight(in kgs)</th>
            <th>Height(in cms)</th>
            <th>Health_History</th>
          </tr>
        </thead>
        <tbody id="data-table-body">
          <!-- Data will be populated here using JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- CDN for Bootstrap JS (for possible future interactivity) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

   <!-- JavaScript to fetch data and populate table -->
   <script>
    // Function to get token from URL parameter
    function getTokenFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token'); // Assume the token is passed as ?token=your_token
    }
  
    // Retrieve the token from URL
    const apiToken = getTokenFromUrl();
  
    if (apiToken) {
      console.log('Token retrieved from URL:', apiToken);
    } else {
      console.log('Token not found in URL');
      // Optionally, redirect to login page or prompt user for credentials
    }
  
    // Fetch data from the Flask API using AJAX
    function fetchData(apiToken) {
      console.log("FETCHING....");
      $.ajax({
        url: "/data",
        method: "GET",
        headers: {
          Authorization: `Bearer ${apiToken}`,
        },
        success: function (data) {
          const tableBody = $("#data-table-body");
          console.log("Data fetched successfully:", data);
  
          // Loop through the data and create rows
          data.forEach((item) => {
            const row = `
              <tr>
                <td><button type="button" class="btn btn-info m-2" id="update_${item.id}">Update</button><button type="button" class="btn btn-danger" id="delete_${item.id}">Delete</button></td>
                <td>${item.id}</td>
                <td>${item.first_name}</td>
                <td>${item.last_name}</td>
                <td>${item.gender}</td>
                <td>${item.age}</td>
                <td>${item.weight}</td>
                <td>${item.height}</td>
                <td>${item.health_history}</td>
              </tr>
            `;
  
            // Append the row to the table body
            tableBody.append(row);
          });
        },
        error: function (xhr, status, error) {
          console.error("Error fetching data:", status, error);
        },
      });
    }
  
    // Call fetchData with the token
    fetchData(apiToken);

    // Handle Insert button click
    $("#insert").click(function () {
        $("#insert-form").toggle(); // Toggle form visibility
      });

      // Handle Insert form cancellation
      $("#cancel-insert").click(function () {
        $("#insert-form").hide();
      });

      // Handle Insert form submission
      $("#data-form").submit(function (event) {
        event.preventDefault();

        // Collect form data
        const formData = {
          first_name: $("#first_name").val(),
          last_name: $("#last_name").val(),
          gender: $("#gender").val(),
          age: $("#age").val(),
          weight: $("#weight").val(),
          height: $("#height").val(),
          health_history: $("#health_history").val(),
        };

        console.log("Sending the following data:", formData);

        // Send data via AJAX to insert it into the database
        $.ajax({
          url: "/insert",
          method: "POST",
          headers: {
            "Authorization": `Bearer ${apiToken}`,
            "Content-Type": "application/json",
            
          },
          data: JSON.stringify(formData),
          success: function (insert) {
            console.log("Data inserted successfully");
            fetchData(apiToken); // Refresh the table with the new data
            $("#insert-form").hide(); // Hide the form after submission
          },
          error: function (xhr, status, error) {
            console.error("Error inserting data:", status, error);
          },
        });
      });
  </script>
  </body>
</html>
